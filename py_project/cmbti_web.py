import streamlit as st
from PIL import Image
import os
import random

st.set_page_config(page_title="C-MBTI ì†Œë¹„ ì„±í–¥ í…ŒìŠ¤íŠ¸", page_icon="ğŸ›ï¸")

AXIS = ["E", "P", "Q", "S", "L", "V", "C", "F"]

# ì§ˆë¬¸ ë¦¬ìŠ¤íŠ¸ ë° ëœë¤ ì„ê¸° (í…ŒìŠ¤íŠ¸ ëê¹Œì§€ ìœ ì§€)
if "questions" not in st.session_state:
    q_list = [
        # ì†Œë¹„ ë™ê¸° (E/P)
        ("ë‚˜ëŠ” ìƒˆë¡œìš´ ê²½í—˜(ì—¬í–‰, ì „ì‹œ, ì²´í—˜ ë“±)ì„ ìœ„í•´ì„œë¼ë©´ ì•½ê°„ ë¹„ì‹¸ë„ ì†Œë¹„í•  ì˜í–¥ì´ ìˆë‹¤.", ("E", "P")),
        ("ë¬¼ê±´ì„ ì‚´ ë•Œ â€˜ì–¼ë§ˆë‚˜ ì˜¤ë˜, ì˜ ì“¸ ìˆ˜ ìˆì„ê¹Œ?â€™ ê°™ì€ ì‹¤ì§ˆì ì¸ íš¨ìš©ì„ ë¨¼ì € ìƒê°í•œë‹¤.", ("P", "E")),
        ("ê¸°ë…ì´ ë  ë§Œí•œ ê²½í—˜ì„ ìœ„í•´ì„œë¼ë©´, ë‹¹ì¥ í•„ìš”í•˜ì§€ ì•Šì•„ë„ ëˆì„ ì“°ëŠ” í¸ì´ë‹¤.", ("E", "P")),
        ("ê°™ì€ ê°€ê²©ì´ë©´ ê¸°ëŠ¥ì´ ë” ì¢‹ì€ ì œí’ˆë³´ë‹¤, ë‚˜ì—ê²Œ íŠ¹ë³„í•œ ê²½í—˜ì„ ì¤„ ìˆ˜ ìˆëŠ” ì„ íƒì§€ê°€ ë” ëŒë¦°ë‹¤.", ("E", "P")),
        ("í‰ì†Œ ì†Œë¹„ ê³„íšì„ ì„¸ìš¸ ë•Œ, ì‹¤ìš©ì ì¸ í•„ìš”ë³´ë‹¤ 'ì¬ë°Œê³  ì˜ë¯¸ ìˆëŠ” ê²½í—˜' í•­ëª©ì´ ë” ë§ì´ ë– ì˜¤ë¥¸ë‹¤.", ("E", "P")),

        # êµ¬ë§¤ ë°©ì‹ (Q/S)
        ("ì‡¼í•‘í•  ë•Œ, ì›ë˜ ì‚¬ë ¤ë˜ ê²ƒ ë§ê³ ë„ ì¦‰í¥ì ìœ¼ë¡œ ëˆˆì— ë„ëŠ” ë¬¼ê±´ì„ ìì£¼ ì‚°ë‹¤.", ("Q", "S")),
        ("í°ì§€ ì‘ì€ì§€ì™€ ê´€ê³„ì—†ì´, ì›¬ë§Œí•œ êµ¬ë§¤ëŠ” ë©°ì¹  ì´ìƒ ê³ ë¯¼í•˜ê³  ë¹„êµí•´ ë³´ëŠ” í¸ì´ë‹¤.", ("S", "Q")),
        ("â€˜ì§€ê¸ˆ ì´ ìˆœê°„ì— ì‚¬ê³  ì‹¶ìœ¼ë‹ˆê¹Œ ì‚°ë‹¤â€™ëŠ” ìƒê°ìœ¼ë¡œ ê²°ì œë¥¼ ëˆ„ë¥´ëŠ” ê²½ìš°ê°€ ë§ë‹¤.", ("Q", "S")),
        ("ì œí’ˆì„ ê³ ë¥¼ ë•Œ ë¦¬ë·°, ê°€ê²©, ëŒ€ì²´ ìƒí’ˆ ë“±ì„ ê¼¼ê¼¼íˆ ë¹„êµí•´ì•¼ ë¹„ë¡œì†Œ ë§ˆìŒì´ ë†“ì¸ë‹¤.", ("S", "Q")),
        ("ì¥ë°”êµ¬ë‹ˆì— ë‹´ì•„ ë‘ê³  ë°”ë¡œ ê²°ì œí•˜ê¸°ë³´ë‹¤, ì‹œê°„ì„ ë‘ê³  ë‹¤ì‹œ ë³´ë©´ì„œ ì‚´ì§€ ë§ì§€ ê²°ì •í•œë‹¤.", ("S", "Q")),

        # ë¸Œëœë“œ íƒœë„ (L/V)
        ("ë¸Œëœë“œì˜ ìŠ¤í† ë¦¬, ì´ë¯¸ì§€, ë””ìì¸ì´ ë§ˆìŒì— ë“¤ë©´ ì•½ê°„ ë¹„ì‹¸ë„ ì„ íƒí•˜ê³  ì‹¶ë‹¤.", ("L", "V")),
        ("ë¬¼ê±´ì„ ê³ ë¥¼ ë•Œ â€˜ì´ê²Œ ë‚˜ì—ê²Œ ì–´ë–¤ ëŠë‚Œì„ ì£¼ëŠ”ê°€â€™ë¥¼ ê°€ê²©ë§Œí¼ ì¤‘ìš”í•˜ê²Œ ë³¸ë‹¤.", ("L", "V")),
        ("ê°™ì€ ì œí’ˆì´ë¼ë©´ ê°ì„±ì ì¸ ë¸Œëœë“œë³´ë‹¤ ê°€ê²© ëŒ€ë¹„ ì„±ëŠ¥ì„ ìš°ì„ í•œë‹¤.", ("V", "L")),
        ("ë¸Œëœë“œ ê°ì„±ë³´ë‹¤ ìŠ¤í™, ê¸°ëŠ¥, ê°€ê²©ì´ í•©ë¦¬ì ì¸ê°€ê°€ ë” ì¤‘ìš”í•˜ë‹¤.", ("V", "L")),
        ("ì‚¬ëŒë“¤ì—ê²Œ ë³´ì´ëŠ” ì´ë¯¸ì§€ë³´ë‹¤ ë‚´ê°€ ì§€ë¶ˆí•œ ëˆ ëŒ€ë¹„ ì´ë“ì¸ê°€ê°€ ì¤‘ìš”í•˜ë‹¤.", ("V", "L")),

        # ì§€ì¶œ ìŠµê´€ (C/F)
        ("ì›”ê¸‰ì´ë‚˜ ìš©ëˆì„ ë°›ìœ¼ë©´ ì˜ˆì‚°ê³¼ í•œë„ë¥¼ ë¨¼ì € ì •í•´ë‘”ë‹¤.", ("C", "F")),
        ("í†µì¥ ì”ê³ ë‚˜ ì¹´ë“œ ë‚´ì—­ì„ ìì£¼ í™•ì¸í•˜ë©° ì§€ì¶œì„ ì¡°ì ˆí•œë‹¤.", ("C", "F")),
        ("ì‚¬ê³  ì‹¶ì€ ê²ƒì´ ìˆìœ¼ë©´ ì˜ˆì‚°ì„ í¬ê²Œ ì‹ ê²½ ì“°ì§€ ì•Šê³  ì§€ë¥´ëŠ” í¸ì´ë‹¤.", ("F", "C")),
        ("ê³„íšì— ì—†ë˜ ì§€ì¶œë„ ì‚¶ì˜ ì¦ê±°ì›€ì„ ìœ„í•´ ë¶€ë‹´ ëŠë¼ì§€ ì•Šê³  ì“´ë‹¤.", ("F", "C")),
        ("ì €ì¶•ë³´ë‹¤ í˜„ì¬ ì‚¶ì˜ ì§ˆì„ ìœ„í•´ ì“°ëŠ” ê²ƒì´ ë” ì¤‘ìš”í•˜ë‹¤.", ("F", "C")),
    ]
    random.shuffle(q_list)
    st.session_state.questions = q_list

# ì ìˆ˜ & ì§ˆë¬¸ ì¸ë±ìŠ¤ ì´ˆê¸°í™”
if "scores" not in st.session_state:
    st.session_state.scores = {k: 0 for k in AXIS}
if "q_index" not in st.session_state:
    st.session_state.q_index = 0
if "finished" not in st.session_state:
    st.session_state.finished = False

# UI ì œëª©
st.title("ğŸ›ï¸ C-MBTI ì†Œë¹„ ì„±í–¥ í…ŒìŠ¤íŠ¸")
st.write("í•˜ë‚˜ì”© ì„ íƒí•´ ì£¼ì„¸ìš”!")
st.markdown("---")

# ì§ˆë¬¸ í˜ì´ì§€ (í…ŒìŠ¤íŠ¸ ì§„í–‰)
if not st.session_state.finished:
    idx = st.session_state.q_index
    total = len(st.session_state.questions)
    st.progress(idx / total)

    q, (a1, a2) = st.session_state.questions[idx]
    st.subheader(f"Q{idx+1}. {q}")

    col1, col2 = st.columns(2)
    with col1:
        if st.button("â‘  ê·¸ë ‡ë‹¤ / ë§¤ìš° ê·¸ë ‡ë‹¤", key=f"yes_{idx}"):
            st.session_state.scores[a1] += 1
            st.session_state.q_index += 1
    with col2:
        if st.button("â‘¡ ì•„ë‹ˆë‹¤ / ê·¸ë ‡ì§€ ì•Šë‹¤", key=f"no_{idx}"):
            st.session_state.scores[a2] += 1
            st.session_state.q_index += 1

    if st.session_state.q_index >= total:
        st.session_state.finished = True
        st.experimental_rerun()

# ê²°ê³¼ í˜ì´ì§€
else:
    st.success("ğŸ‰ í…ŒìŠ¤íŠ¸ ì™„ë£Œ!")

    scores = st.session_state.scores

    # ìš°ì„¸ ì„±í–¥ ë¹„êµë¡œ 4ê¸€ì ìœ í˜• ë§Œë“¤ê¸°
    t1 = "E" if scores["E"] >= scores["P"] else "P"
    t2 = "Q" if scores["Q"] >= scores["S"] else "S"
    t3 = "L" if scores["L"] >= scores["V"] else "V"
    t4 = "C" if scores["C"] >= scores["F"] else "F"

    type_code = t1 + t2 + t3 + t4

    st.header(f"ğŸ“Œ ë‹¹ì‹ ì˜ ì†Œë¹„ ìœ í˜•: **{type_code}**")

    # ê²°ê³¼ ì´ë¯¸ì§€ ìë™ í‘œì‹œ
    img_dir = "images"
    img_file = f"{type_code}.png"
    img_path = os.path.join(img_dir, img_file)

    if os.path.exists(img_path):
        img = Image.open(img_path)
        st.image(img, width=350)
    else:
        st.info("ğŸ–¼ï¸ ì•„ì§ ì´ë¯¸ì§€ ì¤€ë¹„ ì•ˆ ë¨!")

    # -----------------------------
    # ì„±í–¥ ì ìˆ˜ ë¹„êµ ìš”ì•½ ë””ìì¸
    # -----------------------------
    st.subheader("ğŸ§¾ ì†Œë¹„ ì„±í–¥ ì ìˆ˜ ë¹„êµ ìš”ì•½")

    st.markdown("### 1ï¸âƒ£ ì†Œë¹„ ë™ê¸°: ê²½í—˜(E) vs ì‹¤ìš©(P)")
    st.info(f"ê²½í—˜(E): {scores['E']}  â”‚  ì‹¤ìš©(P): {scores['P']}  â†’  **ìš°ì„¸: {t1}**")

    st.markdown("### 2ï¸âƒ£ êµ¬ë§¤ ë°©ì‹: ì¦‰í¥(Q) vs ì‹ ì¤‘(S)")
    st.info(f"ì¦‰í¥(Q): {scores['Q']}  â”‚  ì‹ ì¤‘(S): {scores['S']}  â†’  **ìš°ì„¸: {t2}**")

    st.markdown("### 3ï¸âƒ£ ë¸Œëœë“œ íƒœë„: ê°ì„±(L) vs ê°€ì„±ë¹„(V)")
    st.info(f"ê°ì„±(L): {scores['L']}  â”‚  ê°€ì„±ë¹„(V): {scores['V']}  â†’  **ìš°ì„¸: {t3}**")

    st.markdown("### 4ï¸âƒ£ ì§€ì¶œ ìŠµê´€: ì ˆì œ(C) vs ììœ (F)")
    st.info(f"ì ˆì œ(C): {scores['C']}  â”‚  ììœ (F): {scores['F']}  â†’  **ìš°ì„¸: {t4}**")

    st.markdown("---")

    st.subheader("ğŸ§  ì „ì²´ ì„±í–¥ ë°ì´í„°")
    st.json(scores)

    # ë‹¤ì‹œ í…ŒìŠ¤íŠ¸ ë²„íŠ¼
    if st.button("ğŸ”„ ë‹¤ì‹œ í…ŒìŠ¤íŠ¸í•˜ê¸°"):
        random.shuffle(st.session_state.questions)
        st.session_state.q_index = 0
        st.session_state.finished = False
        st.session_state.scores = {k: 0 for k in AXIS}
        st.experimental_rerun()
