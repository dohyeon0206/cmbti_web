import streamlit as st
from PIL import Image
import os
import random

st.set_page_config(page_title="C-MBTI ì†Œë¹„ ì„±í–¥ í…ŒìŠ¤íŠ¸", page_icon="ğŸ›ï¸")

AXIS = ["E", "P", "Q", "S", "L", "V", "C", "F"]

# -----------------------------
# ìœ í˜• ì´ë¯¸ì§€ ê²½ë¡œ ì°¾ê¸° í•¨ìˆ˜ (png / jpg / jpeg ìë™ íƒìƒ‰)
# -----------------------------
def find_type_image(type_code: str):
    img_dir = "images"
    for ext in [".png", ".jpg", ".jpeg", ".PNG", ".JPG", ".JPEG"]:
        path = os.path.join(img_dir, type_code + ext)
        if os.path.exists(path):
            return path
    return None

# -----------------------------
# ì§ˆë¬¸ ë¦¬ìŠ¤íŠ¸ ì´ˆê¸°í™” & ëœë¤ ì„ê¸° (í…ŒìŠ¤íŠ¸ ë™ì•ˆ ìœ ì§€)
# -----------------------------
if "questions" not in st.session_state:
    q_list = [
        # 1. ì†Œë¹„ ë™ê¸° (E / P)
        ("ë‚˜ëŠ” ìƒˆë¡œìš´ ê²½í—˜(ì—¬í–‰, ì „ì‹œ, ì²´í—˜ ë“±)ì„ ìœ„í•´ì„œë¼ë©´ ì•½ê°„ ë¹„ì‹¸ë„ ì†Œë¹„í•  ì˜í–¥ì´ ìˆë‹¤.", ("E", "P")),
        ("ë¬¼ê±´ì„ ì‚´ ë•Œ 'ì–¼ë§ˆë‚˜ ì˜¤ë˜, ì˜ ì“¸ ìˆ˜ ìˆì„ê¹Œ?' ê°™ì€ ì‹¤ì§ˆì ì¸ íš¨ìš©ì„ ë¨¼ì € ìƒê°í•œë‹¤.", ("P", "E")),
        ("ê¸°ë…ì´ ë  ë§Œí•œ ê²½í—˜ì„ ìœ„í•´ì„œë¼ë©´ ë‹¹ì¥ í•„ìš”í•˜ì§€ ì•Šì•„ë„ ëˆì„ ì“°ëŠ” í¸ì´ë‹¤.", ("E", "P")),
        ("ê°™ì€ ê°€ê²©ì´ë©´ ê¸°ëŠ¥ì´ ë” ì¢‹ì€ ì œí’ˆë³´ë‹¤ ë‚˜ì—ê²Œ íŠ¹ë³„í•œ ê²½í—˜ì„ ì¤„ ì„ íƒì§€ê°€ ë” ëŒë¦°ë‹¤.", ("E", "P")),
        ("ì†Œë¹„ ê³„íšì„ ì„¸ìš¸ ë•Œ ì‹¤ìš©ì ì¸ í•„ìš”ë³´ë‹¤ 'ì˜ë¯¸ ìˆê³  ì¬ë¯¸ìˆëŠ” ê²½í—˜'ì´ ë¨¼ì € ë– ì˜¤ë¥¸ë‹¤.", ("E", "P")),

        # 2. êµ¬ë§¤ ë°©ì‹ (Q / S)
        ("ì‡¼í•‘í•  ë•Œ ì›ë˜ ì‚¬ë ¤ë˜ ê²ƒ ì™¸ì—ë„ ì¦‰í¥ì ìœ¼ë¡œ ëˆˆì— ë„ëŠ” ê±¸ ìì£¼ ì‚°ë‹¤.", ("Q", "S")),
        ("êµ¬ë§¤ëŠ” ëŒ€ë¶€ë¶„ í¬ê¸° ìƒê´€ì—†ì´ ë©°ì¹  ì´ìƒ ê³ ë¯¼í•˜ê³  ë¹„êµí•´ ë³´ëŠ” í¸ì´ë‹¤.", ("S", "Q")),
        ("â€˜ì§€ê¸ˆ ì‚¬ê³  ì‹¶ë‹¤â€™ëŠ” ì´ìœ ë¡œ ë°”ë¡œ ê²°ì œ ë²„íŠ¼ì„ ëˆ„ë¥´ëŠ” ê²½ìš°ê°€ ë§ë‹¤.", ("Q", "S")),
        ("ë¦¬ë·°, ê°€ê²©, ëŒ€ì²´ ìƒí’ˆ ë¹„êµë¥¼ ì¶©ë¶„íˆ í•´ì•¼ ë§ˆìŒì´ ë†“ì¸ë‹¤.", ("S", "Q")),
        ("ì¥ë°”êµ¬ë‹ˆì— ë‹´ì•„ë‘ê³  ë°”ë¡œ ê²°ì œë³´ë‹¤ ì‹œê°„ì„ ë‘ê³  ë‹¤ì‹œ ë³´ê³  ê²°ì •í•œë‹¤.", ("S", "Q")),

        # 3. ë¸Œëœë“œ íƒœë„ (L / V)
        ("ë¸Œëœë“œ ìŠ¤í† ë¦¬, ì´ë¯¸ì§€, ë””ìì¸ì´ ì¢‹ìœ¼ë©´ ì•½ê°„ ë¹„ì‹¸ë„ ì„ íƒí•˜ê³  ì‹¶ë‹¤.", ("L", "V")),
        ("â€˜ë‚˜ì—ê²Œ ì–´ë–¤ ëŠë‚Œì„ ì£¼ëŠ”ê°€?â€™ë¥¼ ê°€ê²©ë§Œí¼ ì¤‘ìš”í•˜ê²Œ ë³¸ë‹¤.", ("L", "V")),
        ("ê°ì„± ë¸Œëœë“œë³´ë‹¤ ê°€ê²© ëŒ€ë¹„ ì„±ëŠ¥ì„ ìš°ì„ í•œë‹¤.", ("V", "L")),
        ("ë¸Œëœë“œ ê°ì„±ë³´ë‹¤ ìŠ¤í™, ê¸°ëŠ¥, ê°€ê²©ì˜ í•©ë¦¬ì„±ì´ ë” ì¤‘ìš”í•˜ë‹¤.", ("V", "L")),
        ("ë‚¨ì—ê²Œ ë³´ì´ëŠ” ì´ë¯¸ì§€ë³´ë‹¤ ì§€ë¶ˆ ëŒ€ë¹„ ì´ë“ì¸ì§€ê°€ ë” ì¤‘ìš”í•˜ë‹¤.", ("V", "L")),

        # 4. ì§€ì¶œ ìŠµê´€ (C / F)
        ("ì›”ê¸‰ì´ë‚˜ ìš©ëˆì„ ë°›ìœ¼ë©´ ë¨¼ì € ì“¸ í•œë„ë¥¼ ì •í•˜ê³  ì†Œë¹„í•œë‹¤.", ("C", "F")),
        ("í†µì¥ ì”ê³ ì™€ ì¹´ë“œ ë‚´ì—­ì„ ìì£¼ í™•ì¸í•˜ë©° ì§€ì¶œì„ ì¡°ì ˆí•œë‹¤.", ("C", "F")),
        ("ì‚¬ê³  ì‹¶ì€ ê²Œ ìƒê¸°ë©´ ì˜ˆì‚°ì„ í¬ê²Œ ì‹ ê²½ ì•ˆ ì“°ê³  ì§€ë¥´ëŠ” í¸ì´ë‹¤.", ("F", "C")),
        ("ê³„íš ë°– ì§€ì¶œë„ ì‚¶ì˜ ì¦ê±°ì›€ì„ ìœ„í•´ ë¶€ë‹´ ì•ˆ ëŠë¼ê³  ì“°ëŠ” í¸ì´ë‹¤.", ("F", "C")),
        ("ì €ì¶•ë³´ë‹¤ í˜„ì¬ ì‚¶ì˜ ì§ˆì„ ìœ„í•´ ì“°ëŠ” ê²ƒì´ ë” ì¤‘ìš”í•˜ë‹¤.", ("F", "C")),
    ]

    random.shuffle(q_list)
    st.session_state.questions = q_list

QUESTIONS = st.session_state.questions

# -----------------------------
# ì ìˆ˜ & ì§ˆë¬¸ ì¸ë±ìŠ¤ ì´ˆê¸°í™”
# -----------------------------
if "scores" not in st.session_state:
    st.session_state.scores = {k: 0 for k in AXIS}

if "q_index" not in st.session_state:
    st.session_state.q_index = 0

if "finished" not in st.session_state:
    st.session_state.finished = False

# -----------------------------
# UI ì‹œì‘
# -----------------------------
st.title("ğŸ›ï¸ C-MBTI ì†Œë¹„ ì„±í–¥ í…ŒìŠ¤íŠ¸")
st.write("ì§ˆë¬¸ì— í•˜ë‚˜ì”© ì„ íƒí•´ ì£¼ì„¸ìš”!")
st.markdown("---")

# -----------------------------
# ì§ˆë¬¸ í˜ì´ì§€ (í…ŒìŠ¤íŠ¸ ì§„í–‰)
# -----------------------------
if not st.session_state.finished:

    idx = st.session_state.q_index
    total = len(QUESTIONS)

    st.progress(idx / total)

    question, (a1, a2) = QUESTIONS[idx]
    st.subheader(f"Q{idx+1}. {question}")

    col1, col2 = st.columns(2)
    with col1:
        if st.button("â‘  ê·¸ë ‡ë‹¤ / ë§¤ìš° ê·¸ë ‡ë‹¤", key=f"yes_{idx}"):
            st.session_state.scores[a1] += 1
            st.session_state.q_index += 1

    with col2:
        if st.button("â‘¡ ì•„ë‹ˆë‹¤ / ê·¸ë ‡ì§€ ì•Šë‹¤", key=f"no_{idx}"):
            st.session_state.scores[a2] += 1
            st.session_state.q_index += 1

    # ë§ˆì§€ë§‰ ì§ˆë¬¸ê¹Œì§€ ë‹¤ í–ˆìœ¼ë©´ ê²°ê³¼ í˜ì´ì§€ë¡œ ì „í™˜
    if st.session_state.q_index >= total:
        st.session_state.finished = True
        st.rerun()

# -----------------------------
# ê²°ê³¼ í˜ì´ì§€
# -----------------------------
else:
    st.success("ğŸ‰ í…ŒìŠ¤íŠ¸ ì™„ë£Œ!")

    scores = st.session_state.scores

    # ìš°ì„¸ ì„±í–¥ ë¹„êµ
    t1 = "E" if scores["E"] >= scores["P"] else "P"
    t2 = "Q" if scores["Q"] >= scores["S"] else "S"
    t3 = "L" if scores["L"] >= scores["V"] else "V"
    t4 = "C" if scores["C"] >= scores["F"] else "F"

    type_code = t1 + t2 + t3 + t4

    st.header(f"ğŸ“Œ ë‹¹ì‹ ì˜ ì†Œë¹„ ìœ í˜•: **{type_code}**")

    # ìœ í˜• ì´ë¯¸ì§€ í‘œì‹œ (png/jpg/jpeg ìë™ íƒìƒ‰)
    img_path = find_type_image(type_code)
    if img_path:
        img = Image.open(img_path)
        st.image(img, width=350)
    else:
        st.info("ğŸ–¼ï¸ ì´ ìœ í˜•ì˜ ì´ë¯¸ì§€ë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. íŒŒì¼ ì´ë¦„/í™•ì¥ìë¥¼ í™•ì¸í•´ ì£¼ì„¸ìš”.")

    # ì„±í–¥ë³„ ì ìˆ˜ ì˜ˆì˜ê²Œ í‘œì‹œ
    st.subheader("ğŸ§¾ ì„±í–¥ ì ìˆ˜ ìš”ì•½")

    st.write(f"**ê²½í—˜(E) : {scores['E']}   â”‚   ì‹¤ìš©(P) : {scores['P']}   â†’   ìš°ì„¸: {t1}**")
    st.write(f"**ì¦‰í¥(Q) : {scores['Q']}   â”‚   ì‹ ì¤‘(S) : {scores['S']}   â†’   ìš°ì„¸: {t2}**")
    st.write(f"**ê°ì„±(L) : {scores['L']}   â”‚   ê°€ì„±ë¹„(V) : {scores['V']}   â†’   ìš°ì„¸: {t3}**")
    st.write(f"**ì ˆì œ(C) : {scores['C']}   â”‚   ììœ (F) : {scores['F']}   â†’   ìš°ì„¸: {t4}**")

    st.markdown("---")

    # ì „ì²´ JSONìœ¼ë¡œë„ ì¶œë ¥
    st.subheader("ğŸ§  ì „ì²´ ì„±í–¥ ë°ì´í„° (ë””ë²„ê¹…/ë¶„ì„ìš©)")
    st.json(scores)

    # ë‹¤ì‹œ í…ŒìŠ¤íŠ¸ ë²„íŠ¼
    if st.button("ğŸ”„ ë‹¤ì‹œ í…ŒìŠ¤íŠ¸í•˜ê¸°"):
        random.shuffle(st.session_state.questions)
        st.session_state.scores = {k: 0 for k in AXIS}
        st.session_state.q_index = 0
        st.session_state.finished = False
        st.rerun()
